<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRODUCTOS SENSITIVOS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    

    <style>
        /* Paleta y estilos principales del código original */
        :root {
            --primary-color: #2c3e50; /* Deep Blue-Grey del Codigo 1 */
            --secondary-color: #7f8c8d; /* Muted Grey del Codigo 1 */
            --accent-color: #3498db; /* Corporate Blue del Codigo 1 */
            --bg-light: #f4f7f9; /* Lighter Grey-Blue Background del Codigo 1 */
            --bg-card: #ffffff; /* White Card Background del Codigo 1 */
            --border-color: #e0e6ea; /* Subtle Border del Codigo 1 */
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c4c;
            --font-main: 'Poppins', sans-serif;
            --highlight-green: #d4edda;
            --highlight-red: #f8d7da;
        }

        /* Estilos generales y resets */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-main);
            background: var(--bg-light);
            color: var(--primary-color);
            padding-bottom: 80px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .main-content {
            padding: 20px;
            max-width: 960px;
            margin: 40px auto; /* Añadido margen superior para mejor look */
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        @media (max-width: 768px) {
            .main-content {
                margin: 20px auto;
                padding: 15px;
            }
        }

        /* Splash Screen */
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-color); color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999;
            transition: opacity 0.7s ease-out; /* Transición más larga */
            text-align: center;
        }
        #splash img { width: 120px; margin-bottom: 20px; }
        #splash h2 { font-weight: 700; font-size: 32px; margin-bottom: 10px; }
        #splash p { margin-top: 5px; font-size: 14px; opacity: 0.9; }

        /* Header & Titles */
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            position: relative;
            padding-left: 60px;
            padding-right: 20px;
        }
        .title-group {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .title-group h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 2px 0;
            color: var(--primary-color);
            text-transform: uppercase;
        }
        @media (max-width: 600px) {
            header { padding-left: 40px; }
            .title-group h1 { font-size: 18px; }
            .hamburger-btn { left: 10px; }
        }
        .hamburger-btn {
            font-size: 28px;
            cursor: pointer;
            color: var(--primary-color);
            padding: 10px;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 5;
        }

        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: var(--primary-color);
            color: white;
            padding: 20px;
            z-index: 1001;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            transition: left 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .side-menu.open { left: 0; }
        .side-menu .action-btn { 
            width: 100%; 
            justify-content: flex-start; 
            margin: 0; 
            background: var(--accent-color);
        }
        .side-menu .action-btn:hover {
            background: #258cdb;
        }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; }
        .overlay.active { display: block; }

        /* Chips & Actions */
        .controls-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 30px; }
        .action-btn {
            background: var(--accent-color);
            color: white;
            border: 0;
            padding: 14px 28px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); }
        .action-btn.danger { background: var(--danger-color); }
        .action-btn.danger:hover { background: #c0392b; }
        .action-btn.green { background: var(--success-color); }
        .action-btn.green:hover { background: #27ae60; }
        .chips { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .chip {
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            background: var(--bg-light);
            color: var(--secondary-color);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .chip.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .chip:hover { transform: translateY(-1px); }

        /* Nuevo estilo para el recuadro de fecha */
        .date-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .date-container label {
            font-weight: 600;
            font-size: 14px;
            color: var(--primary-color);
        }
        .date-container input[type="date"] {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: var(--font-main);
            font-size: 16px;
            background: var(--bg-light);
            transition: all 0.3s ease;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-radius: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse; /* Cambiado a collapse para el diseño corporativo */
            font-size: 14px;
            background: var(--bg-card);
        }
        th, td { border: 1px solid var(--border-color); padding: 15px; text-align: center; }
        th { background: var(--primary-color); color: white; font-weight: 600; white-space: nowrap; }
        td.left { text-align: left; }
        th.product-sensitive { white-space: normal; line-height: 1.2; }

        /* Estilo de input dentro de celda */
        td input[type="number"] { 
            width: 100%; 
            border: 0; 
            text-align: center; 
            background: transparent; 
            font-size: 14px; 
            padding: 2px; 
            outline: none; 
            transition: background-color 0.3s;
            color: var(--primary-color);
        }
        td input[type="number"]:focus {
            background-color: var(--bg-light);
            box-shadow: inset 0 0 0 2px var(--accent-color);
        }
        td[contenteditable="true"] { 
            background: var(--bg-light); /* Fondo para indicar que es editable */
            padding: 15px;
            outline: none;
            transition: box-shadow 0.3s;
        }
        td[contenteditable="true"]:focus {
            box-shadow: inset 0 0 0 2px var(--accent-color);
        }
        .selected-row { background-color: #e0f7fa !important; }
        .initial-highlight { background-color: var(--highlight-yellow) !important; }
        .increased { background-color: var(--highlight-green) !important; }
        .decreased { background-color: var(--highlight-red) !important; }

        /* Toast notifications - MISMA POSICIÓN QUE EL CÓDIGO 1 */
        #toast-container {
            position: fixed;
            top: 30px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            flex-direction: column; 
            align-items: center;
        }
        .toast {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 10px; 
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-20px); 
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            min-width: 250px; 
            justify-content: center;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: var(--success-color); }
        .toast.warning { background-color: var(--warning-color); }
        .toast.error { background-color: var(--danger-color); }

        /* Modals - IGUALES AL CÓDIGO 1 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content.large-text {
            max-width: 600px;
            text-align: left;
            padding: 25px 40px;
        }
        .modal-content h2 { color: var(--primary-color); font-size: 24px; margin-bottom: 10px; }
        .modal-content p, .modal-content li { color: var(--secondary-color); font-size: 14px; line-height: 1.6; }
        .modal-icon { font-size: 48px; color: var(--danger-color); margin-bottom: 20px; }
        .modal-actions { display: flex; justify-content: space-around; gap: 15px; }
        .modal-actions button { flex: 1; }
        .close-btn { color: var(--secondary-color); position: absolute; top: 15px; right: 25px; font-size: 28px; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover, .close-btn:focus { color: var(--primary-color); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Footer - MISMO DISEÑO QUE EL CÓDIGO 1 */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px 0;
            font-size: 12px;
            color: var(--secondary-color);
        }
        .footer a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        .footer a:hover {
            color: var(--primary-color);
        }
        .footer .divider {
            color: var(--secondary-color);
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div id="splash">
        <img src="icon-192.png" alt="Logo">
        <h2>PRODUCTOS</h2>
        <h2>SENSITIVOS</h2>
        <p>Powered by Rafael Ramos.</p>
        <p>Versión 2.0</p>
    </div>

    <div id="sideMenu" class="side-menu">
        <button id="btnExportJson_menu" class="action-btn"><i class="fas fa-file-export"></i> Exportar Datos</button>
        <input type="file" id="fileInput" style="display: none;" accept=".json">
        <button id="btnImportJson_menu" class="action-btn"><i class="fas fa-file-import"></i> Importar Datos</button>
    </div>
    <div id="overlay" class="overlay"></div>

    <div class="container main-content">
        <header>
            <div id="hamburgerBtn" class="hamburger-btn"><i class="fas fa-bars"></i></div>
            <div class="title-group">
                <h1>GRUPO RIBA SMITH</h1>
                <h1>R/S CHITRÉ SELECTO</h1>
                <h1>LISTADO DE PRODUCTOS SENSITIVOS</h1>
            </div>
        </header>

        <div class="date-container">
            <label for="review-date"><i class="fas fa-calendar-alt"></i> Fecha de Revisión:</label>
            <input type="date" id="review-date">
        </div>

        <div class="controls-container">
            <div class="chips" id="chips"></div>
        </div>

        <div class="actions">
            <button id="btnAdd" class="action-btn"><i class="fas fa-plus"></i> Agregar Fila</button>
            <button id="btnExport" class="action-btn green"><i class="fas fa-file-pdf"></i> Generar PDF</button>
            <button id="btnClear" class="action-btn danger"><i class="fas fa-eraser"></i> Borrar Horarios</button>
            <button id="btnDeleteRow" class="action-btn danger"><i class="fas fa-trash-alt"></i> Eliminar Fila</button>
        </div>

        <div class="table-container">
            <table id="tabla">
                <thead>
                    <tr>
                        <th style="width: 10%;">PRECIO</th>
                        <th class="left product-sensitive" style="width: 40%;">PRODUCTO<br>SENSITIVO</th>
                        <th style="width: 12.5%;">07:00</th>
                        <th style="width: 12.5%;">12:00</th>
                        <th style="width: 12.5%;">15:00</th>
                        <th style="width: 12.5%;">22:00</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>

        <div id="toast-container"></div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <i class="fas fa-trash-alt modal-icon"></i>
            <h2>¿Eliminar Fila?</h2>
            <p>Esta acción no se puede deshacer.</p>
            <div class="modal-actions">
                <button id="modalConfirmBtn" class="action-btn danger">Confirmar</button>
                <button id="modalCancelBtn" class="action-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="clearModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <i class="fas fa-eraser modal-icon"></i>
            <h2>¿Borrar Horarios?</h2>
            <p>Esta acción eliminará todos los horarios de la sección activa.</p>
            <div class="modal-actions">
                <button id="clearModalConfirmBtn" class="action-btn danger">Confirmar</button>
                <button id="clearModalCancelBtn" class="action-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="termsModal" class="modal">
        <div class="modal-content large-text">
            <span class="close-btn">&times;</span>
            <h2>Términos y Condiciones</h2>
            <p>
                Este sistema de listado y control de producto es una herramienta interna y exclusiva, propiedad de Rafael Ramos, diseñada para el personal de seguridad de la sucursal R/S Chitré Selecto.
            </p>
            <p>
                Al utilizar esta aplicación, usted reconoce y acepta los siguientes términos:
            </p>
            <ul>
                <li><strong>Uso del Sistema:</strong> La aplicación está destinada únicamente para la gestión de productos sensitivos y el control de los mismos, como parte de las funciones laborales asignadas. Cualquier otro uso está estrictamente prohibido.</li>
                <li><strong>Confidencialidad y Propiedad de Datos:</strong> Los datos registrados, incluyendo precios, nombres de productos y cualquier otra información ingresada, son propiedad exclusiva de R/S Chitré Selecto. Esta información es confidencial y no debe ser divulgada a terceros.</li>
                <li><strong>Precisión de la Información:</strong> Usted es responsable de garantizar que la información que ingresa sea veraz, precisa y completa. Cualquier registro falso, inexacto o incompleto es de su única responsabilidad y podría ser sujeto a medidas disciplinarias.</li>
                <li><strong>Propiedad Intelectual:</strong> La aplicación, incluyendo su código fuente, diseño, interfaz y contenido, es propiedad intelectual de Rafael Ramos y se prohíbe su copia, distribución o modificación sin autorización expresa.</li>
                <li><strong>Limitación de Responsabilidad:</strong> Rafael Ramos no se hace responsable por daños directos o indirectos, pérdidas o inconvenientes que surjan del uso o la imposibilidad de usar esta aplicación, incluyendo fallas técnicas o errores humanos.</li>
                <li><strong>Modificaciones a los Términos:</strong> Nos reservamos el derecho de actualizar, modificar o reemplazar estos términos y condiciones en cualquier momento. El uso continuado de la aplicación después de cualquier modificación constituye su aceptación de los nuevos términos.</li>
            </ul>
        </div>
    </div>

    <div id="privacyModal" class="modal">
        <div class="modal-content large-text">
            <span class="close-btn">&times;</span>
            <h2>Política de Privacidad</h2>
            <p>
                Esta Política de Privacidad describe cómo se recopila, utiliza y protege la información en la aplicación "PRODUCTOS SENSITIVOS" para la sucursal R/S Chitré Selecto.
            </p>
            <p>
                <strong>Información Recopilada:</strong> La aplicación registra precios y nombres de productos, junto con los horarios de control. Esta información es de uso exclusivo para la gestión interna de la empresa y no incluye datos personales sensibles del usuario.
            </p>
            <p>
                <strong>Uso de la Información:</strong> La información recopilada se utiliza únicamente para el monitoreo, control de inventario y seguridad interna. No se comparte, vende ni distribuye a terceros externos a la organización.
            </p>
            <p>
                <strong>Protección de Datos:</strong> Se toman medidas de seguridad para proteger los datos contra el acceso no autorizado. Los datos se almacenan de forma local en el dispositivo del usuario para garantizar la confidencialidad.
            </p>
            <p>
                <strong>Cambios en la Política:</strong> Nos reservamos el derecho de modificar esta Política de Privacidad. Se notificará a los usuarios sobre cualquier cambio a través de la propia aplicación.
            </p>
        </div>
    </div>

    <footer class="footer">
        <p>
            © 2025 Rafael Ramos. Todos los derechos reservados.
            <a href="#" id="openTermsModal">Términos y Condiciones</a>
            <span class="divider">|</span>
            <a href="#" id="openPrivacyModal">Política de Privacidad</a>
        </p>
    </footer>

    <script>
        // Importante: La librería jsPDF está disponible globalmente como window.jspdf.jsPDF después de cargar el script.
        const { jsPDF } = window.jspdf;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Fallo en el registro de Service Worker:', error);
                    });
            });
        }

        (function () {
            const DEFAULT_SECCIONES = ['FORMULAS','MEDICAMENTOS','CAVA','PASTILLAS CANINAS','LICORES'];
            const STORAGE_KEY = 'productos_sensitivos_por_seccion';
            let productos = [];
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                productos = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(productos)) productos = [];
            } catch (e) {
                console.warn('localStorage JSON corrupto, reiniciando datos:', e);
                productos = [];
            }
            let seccionActiva = productos.length > 0 ? productos[0].seccion : DEFAULT_SECCIONES[0]; // Asegura una sección activa al inicio
            let insertIndex = null;
            let selectedRow = null;
            const tbody = document.getElementById('tbody');
            const chipsEl = document.getElementById('chips');
            const btnExport = document.getElementById('btnExport');
            const btnClear = document.getElementById('btnClear');
            const btnAdd = document.getElementById('btnAdd');
            const btnDeleteRow = document.getElementById('btnDeleteRow');
            const toastContainer = document.getElementById('toast-container'); // Referencia al nuevo contenedor
            const fileInput = document.getElementById('fileInput');
            const btnExportJson_menu = document.getElementById('btnExportJson_menu');
            const btnImportJson_menu = document.getElementById('btnImportJson_menu');
            const sideMenu = document.getElementById('sideMenu');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const overlay = document.getElementById('overlay');
            const deleteModal = document.getElementById('deleteModal');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const clearModal = document.getElementById('clearModal');
            const clearModalConfirmBtn = document.getElementById('clearModalConfirmBtn');
            const clearModalCancelBtn = document.getElementById('clearModalCancelBtn');
            const termsModal = document.getElementById('termsModal');
            const openTermsModalBtn = document.getElementById('openTermsModal');
            const privacyModal = document.getElementById('privacyModal');
            const openPrivacyModalBtn = document.getElementById('openPrivacyModal');
            const allCloseBtns = document.querySelectorAll('.close-btn');
            const reviewDateInput = document.getElementById('review-date');
            
            let currentToastElement = null; // Para loading toast
            let saveTimer = null;

            function save() {
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(productos));
                }, 300);
            }
            // =========================================================================
            // LÓGICA DE TOASTS (ADAPTADA DEL CÓDIGO 1)
            // =========================================================================
            function showToast(message, type = 'success', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="${getIcon(type)}"></i> ${message}`;

                toastContainer.prepend(toast); 

                setTimeout(() => { toast.classList.add('show'); }, 10); 

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => { toast.remove(); }, 300); 
                }, duration);
            }

            function getIcon(type) {
                switch(type) {
                    case 'success': return 'fas fa-check-circle';
                    case 'warning': return 'fas fa-exclamation-triangle';
                    case 'error': return 'fas fa-times-circle';
                    default: return 'fas fa-info-circle';
                }
            }

            function showLoadingToast(message) {
                if (currentToastElement) hideToast(currentToastElement); 

                const toast = document.createElement('div');
                toast.className = 'toast loading-toast';
                toast.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;

                toastContainer.prepend(toast);
                currentToastElement = toast;

                setTimeout(() => { toast.classList.add('show'); }, 10); 
                return toast;
            }

            function hideToast(toastElement) {
                if (toastElement) {
                    toastElement.classList.remove('show');
                    setTimeout(() => { 
                        toastElement.remove(); 
                        if (toastElement === currentToastElement) {
                            currentToastElement = null;
                        }
                    }, 300);
                }
            }
            // =========================================================================
            // FIN LÓGICA DE TOASTS
            // =========================================================================


            // Función para verificar diferencias en una sección (sólo muestra advertencia)
            function checkDifferencesInActiveSection() {
                const list = productos.filter(p => p.seccion === seccionActiva);
                const timeFields = ['t0700', 't1200', 't1500', 't2200'];

                for (const p of list) {
                    for (let i = 1; i < timeFields.length; i++) {
                        const currentVal = parseFloat(p[timeFields[i]]);
                        const prevVal = parseFloat(p[timeFields[i - 1]]);

                        if (!isNaN(currentVal) && !isNaN(prevVal) && currentVal < prevVal) {
                            showToast('¡Advertencia! Se detectó una disminución en un valor de inventario.', 'warning');
                            return; 
                        }
                    }
                }
            }

            function renderChips() {
                chipsEl.innerHTML = '';
                DEFAULT_SECCIONES.forEach(s => {
                    const b = document.createElement('div');
                    b.className = 'chip' + (s === seccionActiva ? ' active' : '');
                    b.textContent = s;
                    b.onclick = () => {
                        const previousSection = seccionActiva;
                        if (s !== previousSection) {
                            seccionActiva = s;
                            render();
                            checkDifferencesInActiveSection();
                        }
                    };
                    chipsEl.appendChild(b);
                });
            }
            const applyColorAndAlertLogic = (targetInput, suppressToast = true) => {
                const currentRowInputs = Array.from(targetInput.closest('tr').querySelectorAll('input[type="number"]'));
                const currentIndex = currentRowInputs.indexOf(targetInput);
                const currentValue = parseFloat(targetInput.value);
                const prevInput = currentRowInputs[currentIndex - 1];
                const prevValue = prevInput ? parseFloat(prevInput.value) : NaN;

                // Limpiar todas las clases de coloración
                targetInput.classList.remove('initial-highlight', 'increased', 'decreased');

                // Si es la primera columna de tiempo, no hay comparación previa.
                if (currentIndex === 0) return; 

                if (!isNaN(currentValue) && !isNaN(prevValue)) {
                    if (currentValue < prevValue) {
                        targetInput.classList.add('decreased');
                        if (!suppressToast) showToast('¡Advertencia! Disminución detectada.', 'warning', 2000);
                    } else if (currentValue > prevValue) {
                        targetInput.classList.add('increased');
                    }
                }
            };

            function createRowElement(p, indexInList) {
                const tr = document.createElement('tr');
                tr.dataset.index = indexInList;
                const tdPrecio = document.createElement('td');
                tdPrecio.contentEditable = "true";
                tdPrecio.dataset.field = "precio";
                tdPrecio.textContent = p.precio || '';
                tr.appendChild(tdPrecio);
                const tdNombre = document.createElement('td');
                tdNombre.className = 'left';
                tdNombre.contentEditable = "true";
                tdNombre.dataset.field = "nombre";
                tdNombre.textContent = p.nombre || '';
                tr.appendChild(tdNombre);
                ['t0700','t1200','t1500','t2200'].forEach(field => {
                    const td = document.createElement('td');
                    const inp = document.createElement('input');
                    inp.type = 'number';
                    inp.dataset.field = field;
                    inp.value = p[field] || '';
                    td.appendChild(inp);
                    tr.appendChild(td);
                });
                return tr;
            }
            
            function render() {
                renderChips();
                tbody.innerHTML = '';
                selectedRow = null;
                insertIndex = null;
                const list = productos.filter(p => p.seccion === seccionActiva);
                
                if (!list.length) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 6;
                    td.style.color = 'var(--secondary-color)';
                    td.style.textAlign = 'center';
                    td.style.padding = '20px';
                    td.textContent = 'Sin productos en esta sección.';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                    return;
                }
                
                // Mapear el producto a su índice original antes de filtrar
                const productsWithOriginalIndex = list.map(p => ({
                    product: p,
                    originalIndex: productos.indexOf(p)
                }));
                
                productsWithOriginalIndex.forEach(item => {
                    const { product: p, originalIndex } = item;
                    const tr = createRowElement(p, originalIndex); // Usar originalIndex

                    tr.querySelectorAll('[contenteditable="true"]').forEach(td => {
                        td.addEventListener('blur', () => {
                            const field = td.dataset.field;
                            const index = parseInt(tr.dataset.index); // Obtener el índice del atributo
                            if (index > -1) {
                                productos[index][field] = td.innerText.trim();
                                save();
                            }
                        });
                    });
                    
                    const inputs = Array.from(tr.querySelectorAll('input[type="number"]'));
                    inputs.forEach((inp, idx) => {
                        applyColorAndAlertLogic(inp, true);
                        inp.addEventListener('input', () => {
                            const index = parseInt(tr.dataset.index);
                            const field = inp.dataset.field;
                            const newValue = inp.value.trim();
                            
                            if (index > -1) {
                                productos[index][field] = newValue;
                                save();
                                applyColorAndAlertLogic(inp, false);
                                // Forzar la re-evaluación de las celdas posteriores en la misma fila
                                const currentRowInputs = Array.from(inp.closest('tr').querySelectorAll('input[type="number"]'));
                                const currentIndex = currentRowInputs.indexOf(inp);
                                for (let j = currentIndex + 1; j < currentRowInputs.length; j++) {
                                    applyColorAndAlertLogic(currentRowInputs[j], true);
                                }
                            }
                        });
                    });
                    
                    tr.addEventListener('click', () => {
                        if (selectedRow) selectedRow.classList.remove('selected-row');
                        selectedRow = tr;
                        selectedRow.classList.add('selected-row');
                        insertIndex = parseInt(tr.dataset.index); // Usar el índice original
                    });
                    tbody.appendChild(tr);
                });
            }
            
            btnAdd.onclick = () => {
                const f = { seccion: seccionActiva, precio: '', nombre: '', t0700: '', t1200: '', t1500: '', t2200: '' };
                const list = productos.filter(p => p.seccion === seccionActiva);
                
                if (list.length === 0) {
                     // Si no hay elementos en la sección, simplemente lo agregamos al final (o inicio)
                     productos.push(f);
                     showToast('Fila agregada.', 'success');
                } else if (selectedRow) {
                    // Si se seleccionó una fila, insertamos después de ella.
                    // Buscamos el índice en la lista original donde debemos insertar
                    const indexToInsert = productos.findIndex(p => p.seccion === seccionActiva && p === list.find(l => l.nombre === selectedRow.querySelector('td.left').textContent.trim()));
                    if (indexToInsert > -1) {
                         productos.splice(indexToInsert + 1, 0, f);
                         showToast('Fila agregada.', 'success');
                    } else {
                        // Fallback si no se encuentra (debería ser raro)
                        productos.push(f);
                        showToast('Fila agregada al final.', 'success');
                    }
                } else {
                    // Si no se seleccionó ninguna fila, lo agregamos después del último de la sección
                    const lastIndexInSection = productos.map(p => p.seccion).lastIndexOf(seccionActiva);
                    if (lastIndexInSection > -1) {
                        productos.splice(lastIndexInSection + 1, 0, f);
                        showToast('Fila agregada.', 'success');
                    } else {
                        // Si la sección no existe en la lista (caso inicial)
                        productos.push(f);
                        showToast('Fila agregada al final.', 'success');
                    }
                }

                save();
                render();
            };

            btnDeleteRow.onclick = () => {
                if (selectedRow) {
                    deleteModal.style.display = 'flex';
                } else {
                    showToast('Selecciona una fila para eliminar.', 'error');
                }
            };
            btnClear.onclick = () => {
                clearModal.style.display = 'flex';
            };
            modalConfirmBtn.onclick = () => {
                if (selectedRow) {
                    const indexToDelete = parseInt(selectedRow.dataset.index);
                    if (indexToDelete > -1) {
                        productos.splice(indexToDelete, 1);
                        save();
                        render();
                        showToast('Fila eliminada.', 'success');
                    }
                    deleteModal.style.display = 'none';
                    selectedRow = null;
                    insertIndex = null;
                }
            };
            modalCancelBtn.onclick = () => {
                deleteModal.style.display = 'none';
            };
            clearModalConfirmBtn.onclick = () => {
                productos = productos.map(p => p.seccion === seccionActiva ? { ...p, t0700: '', t1200: '', t1500: '', t2200: '' } : p);
                save();
                render();
                showToast('Horarios borrados.', 'success');
                clearModal.style.display = 'none';
            };
            clearModalCancelBtn.onclick = () => {
                clearModal.style.display = 'none';
            };

            allCloseBtns.forEach(btn => {
                btn.onclick = () => { btn.closest('.modal').style.display = 'none'; };
            });

            openTermsModalBtn.onclick = (e) => {
                e.preventDefault();
                termsModal.style.display = 'flex';
            };

            openPrivacyModalBtn.onclick = (e) => {
                e.preventDefault();
                privacyModal.style.display = 'flex';
            };

            window.onclick = (event) => {
                if (event.target === deleteModal) deleteModal.style.display = 'none';
                if (event.target === clearModal) clearModal.style.display = 'none';
                if (event.target === termsModal) termsModal.style.display = 'none';
                if (event.target === privacyModal) privacyModal.style.display = 'none';
            };

            // Lógica para determinar el estilo de la celda en PDF
            function getPdfCellColor(currentValue, prevValue) {
                const numCurrent = parseFloat(currentValue);
                const numPrev = parseFloat(prevValue);
                
                if (isNaN(numCurrent) || isNaN(numPrev)) return null;

                const increasedColor = [212, 237, 218]; // highlight-green
                const decreasedColor = [248, 215, 218]; // highlight-red

                if (numCurrent < numPrev) return decreasedColor;
                if (numCurrent > numPrev) return increasedColor;
                return null;
            }

            // ******************************************************************
            // ************ FUNCIÓN DE EXPORTACIÓN CON jsPDF.autoTable() *********
            // ******************************************************************
            btnExport.onclick = () => {
                const dataAvailable = productos.filter(p => DEFAULT_SECCIONES.includes(p.seccion)).length > 0;
                
                if (!dataAvailable) {
                    showToast('No hay datos para exportar.', 'warning');
                    return;
                }

                if (typeof window.jspdf === 'undefined' || typeof window.jspdf.AcroForm === 'undefined') {
                    showToast('Error: Librería de jsPDF o AutoTable no cargada.', 'error');
                    return;
                }

                const loadingToast = showLoadingToast('Generando PDF... por favor espere.');

                setTimeout(() => { 
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4'); 
                        const marginX = 15;
                        const pageHeight = doc.internal.pageSize.height;
                        let isFirstPage = true;

                        const reviewDateValue = reviewDateInput.value;
                        let formattedReviewDate = 'N/A';
                        if (reviewDateValue) {
                            const [y, m, d] = reviewDateValue.split('-');
                            formattedReviewDate = `${d}/${m}/${y}`;
                        } else {
                            const today = new Date();
                            formattedReviewDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
                        }

                        const PDF_MAIN_TITLE = "LISTADO DE PRODUCTOS SENSITIVOS";

                        const addHeaderAndFooter = (doc, title) => { 
                            let yPos = 15;

                            doc.setFontSize(16).setFont('helvetica', 'bold');
                            doc.text("GRUPO RIBA SMITH", doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                            yPos += 6;
                            doc.setFontSize(12).setFont('helvetica', 'normal');
                            doc.text("R/S CHITRÉ SELECTO", doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                            yPos += 5;

                            doc.setFontSize(14).setFont('helvetica', 'bold');
                            const mainTitleLines = doc.splitTextToSize(PDF_MAIN_TITLE, doc.internal.pageSize.width - marginX * 2);
                            doc.text(mainTitleLines, doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                            yPos += (mainTitleLines.length * 5) + 3;

                            doc.setFontSize(12).setFont('helvetica', 'bold');
                            const sectionTitleLines = doc.splitTextToSize(`SECCIÓN: ${title}`, doc.internal.pageSize.width - marginX * 2);
                            doc.text(sectionTitleLines, doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                            yPos += (sectionTitleLines.length * 5) + 3;

                            doc.setFontSize(10).setFont('helvetica', 'normal'); 
                            doc.text(`Fecha de Revisión: ${formattedReviewDate}`, marginX, yPos);

                            yPos += 8;
                            
                            doc.setFontSize(8).setFont('helvetica', 'normal');
                            doc.text(`Página ${doc.internal.getNumberOfPages()}`, doc.internal.pageSize.width - marginX, 10, { align: 'right' }); 

                            const footerText = 'Powered by Rafael Ramos';
                            doc.text(footerText, doc.internal.pageSize.width / 2, pageHeight - 5, { align: 'center' });

                            return yPos;
                        };

                        const headers = [
                            { header: 'PRECIO', dataKey: 'precio' },
                            { header: 'PRODUCTO SENSITIVO', dataKey: 'nombre' },
                            { header: '07:00', dataKey: 't0700' },
                            { header: '12:00', dataKey: 't1200' },
                            { header: '15:00', dataKey: 't1500' },
                            { header: '22:00', dataKey: 't2200' },
                        ];

                        DEFAULT_SECCIONES.forEach(seccion => {
                            const sectionData = productos.filter(p => p.seccion === seccion);

                            if (sectionData.length > 0) {
                                if (!isFirstPage) {
                                    doc.addPage();
                                }
                                isFirstPage = false;
                                
                                let currentY = addHeaderAndFooter(doc, seccion);
                                
                                const body = sectionData.map(d => [
                                    d.precio || '', d.nombre || '', d.t0700 || '', d.t1200 || '', d.t1500 || '', d.t2200 || ''
                                ]);

                                doc.autoTable({
                                    startY: currentY,
                                    head: [headers.map(h => h.header)],
                                    body: body,
                                    theme: 'grid',
                                    styles: { fontSize: 8, cellPadding: 2, halign: 'center', minCellHeight: 8 },
                                    headStyles: { fillColor: [44, 62, 80], textColor: [255, 255, 255], fontStyle: 'bold' },
                                    columnStyles: {
                                        0: { cellWidth: 15 }, // Precio
                                        1: { cellWidth: 75, halign: 'left' }, // Producto
                                        2: { cellWidth: 20 }, // 07:00
                                        3: { cellWidth: 20 }, // 12:00
                                        4: { cellWidth: 20 }, // 15:00
                                        5: { cellWidth: 20 }, // 22:00
                                    },
                                    tableWidth: 'wrap', 
                                    margin: { left: marginX, right: marginX, top: 15, bottom: 15 }, 
                                    
                                    // HOOK para colorear las celdas
                                    didParseCell: (data) => {
                                        const rowData = sectionData[data.row.index];
                                        const colIndex = data.column.index;
                                        let fillColor = null;
                                        
                                        if (colIndex === 3) { // 12:00 (compara con 07:00)
                                            fillColor = getPdfCellColor(rowData.t1200, rowData.t0700);
                                        } else if (colIndex === 4) { // 15:00 (compara con 12:00)
                                            fillColor = getPdfCellColor(rowData.t1500, rowData.t1200);
                                        } else if (colIndex === 5) { // 22:00 (compara con 15:00)
                                            fillColor = getPdfCellColor(rowData.t2200, rowData.t1500);
                                        }
                                        
                                        if (fillColor) {
                                            data.cell.styles.fillColor = fillColor;
                                        }
                                    },

                                    didDrawPage: (data) => {
                                        doc.setFontSize(8).setFont('helvetica', 'normal');
                                        const footerText = 'Powered by Rafael Ramos';
                                        doc.text(footerText, doc.internal.pageSize.width / 2, pageHeight - 5, { align: 'center' });

                                        // Si es una página de continuación de tabla, reimprimir el encabezado
                                        if (data.pageNumber > 1) { 
                                            doc.text(`Página ${doc.internal.getNumberOfPages()}`, doc.internal.pageSize.width - marginX, 10, { align: 'right' }); 
                                            data.cursor.y = 15; // Mover la tabla hacia abajo para el encabezado de página
                                        }
                                    }
                                });
                            }
                        });


                        doc.save(`Productos_Sensitivos_${formattedReviewDate.replace(/\//g, '-')}.pdf`);

                        hideToast(loadingToast);
                        showToast('¡PDF guardado con éxito!', 'success', 4000);
                    } catch (e) {
                        console.error("Error al generar el PDF:", e);
                        hideToast(loadingToast);
                        showToast('Error al generar el PDF. Revise la consola.', 'error', 5000);
                    }
                }, 100);
            };
            // ******************************************************************
            // ************ FIN DE FUNCIÓN CON jsPDF.autoTable() ****************
            // ******************************************************************

            const handleExportJson = () => {
                if (!productos.length) {
                    showToast('No hay datos para exportar.', 'warning');
                    return;
                }
                const dataStr = JSON.stringify(productos, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_productos_sensitivos_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Datos exportados.', 'success');
            };
            const handleImportJson = () => {
                fileInput.click();
            };
            btnExportJson_menu.onclick = handleExportJson;
            btnImportJson_menu.onclick = handleImportJson;
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData) && importedData.every(item => 'seccion' in item && 'nombre' in item)) {
                            productos = importedData;
                            save();
                            render();
                            showToast('Datos importados con éxito.', 'success');
                        } else {
                            showToast('Archivo JSON no válido.', 'error');
                        }
                    } catch (error) {
                        showToast('Error al procesar el archivo.', 'error');
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            };
            hamburgerBtn.addEventListener('click', () => {
                sideMenu.classList.toggle('open');
                overlay.classList.toggle('active');
            });
            overlay.addEventListener('click', () => {
                sideMenu.classList.remove('open');
                overlay.classList.remove('active');
            });

            function getTodayDateFormattedForInput() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            window.addEventListener("load", () => {
                // Esconde la pantalla de inicio
                setTimeout(() => { document.getElementById("splash").style.opacity = "0"; }, 1500);
                setTimeout(() => { document.getElementById("splash").style.display = "none"; }, 2000);
                
                if (!reviewDateInput.value) {
                    reviewDateInput.value = getTodayDateFormattedForInput();
                }
                render();
                checkDifferencesInActiveSection();
            });
        })();
    </script>
</body>
</html>
